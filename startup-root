#!/system/bin/sh
# Called from modprobe-payload
# Now in root user + permissive domain (u:r:vendor_modprobe:s0)

BASE_DIR=$(readlink -f $(dirname $0))

if [ -z "$1" ]; then
    log=$BASE_DIR/root-log1

    # BOOTCLASSPATH is required for magiskd
    export ANDROID_DATA=/data
    export ANDROID_ART_ROOT=/apex/com.android.art
    export ANDROID_TZDATA_ROOT=/apex/com.android.tzdata
    export SYSTEMSERVERCLASSPATH=/system/framework/com.android.location.provider.jar:/system/framework/services.jar:/system/framework/ethernet-service.jar:/apex/com.android.appsearch/javalib/service-appsearch.jar:/apex/com.android.media/javalib/service-media-s.jar:/apex/com.android.permission/javalib/service-permission.jar
    export TERM=xterm-256color
    export ANDROID_SOCKET_adbd=23
    export ANDROID_STORAGE=/storage
    export EXTERNAL_STORAGE=/sdcard
    export DOWNLOAD_CACHE=/data/cache
    export ANDROID_ASSETS=/system/app
    export STANDALONE_SYSTEMSERVER_JARS=
    export DEX2OATBOOTCLASSPATH=/apex/com.android.art/javalib/core-oj.jar:/apex/com.android.art/javalib/core-libart.jar:/apex/com.android.art/javalib/okhttp.jar:/apex/com.android.art/javalib/bouncycastle.jar:/apex/com.android.art/javalib/apache-xml.jar:/system/framework/framework.jar:/system/framework/framework-graphics.jar:/system/framework/ext.jar:/system/framework/telephony-common.jar:/system/framework/voip-common.jar:/system/framework/ims-common.jar:/apex/com.android.i18n/javalib/core-icu4j.jar
    export BOOTCLASSPATH=/apex/com.android.art/javalib/core-oj.jar:/apex/com.android.art/javalib/core-libart.jar:/apex/com.android.art/javalib/okhttp.jar:/apex/com.android.art/javalib/bouncycastle.jar:/apex/com.android.art/javalib/apache-xml.jar:/system/framework/framework.jar:/system/framework/framework-graphics.jar:/system/framework/ext.jar:/system/framework/telephony-common.jar:/system/framework/voip-common.jar:/system/framework/ims-common.jar:/apex/com.android.i18n/javalib/core-icu4j.jar:/apex/com.android.appsearch/javalib/framework-appsearch.jar:/apex/com.android.conscrypt/javalib/conscrypt.jar:/apex/com.android.ipsec/javalib/android.net.ipsec.ike.jar:/apex/com.android.media/javalib/updatable-media.jar:/apex/com.android.mediaprovider/javalib/framework-mediaprovider.jar:/apex/com.android.os.statsd/javalib/framework-statsd.jar:/apex/com.android.permission/javalib/framework-permission.jar:/apex/com.android.permission/javalib/framework-permission-s.jar:/apex/com.android.scheduling/javalib/framework-scheduling.jar:/apex/com.android.sdkext/javalib/framework-sdkextensions.jar:/apex/com.android.tethering/javalib/framework-connectivity.jar:/apex/com.android.tethering/javalib/framework-tethering.jar:/apex/com.android.wifi/javalib/framework-wifi.jar
    export SHELL=/bin/sh
    export ANDROID_BOOTLOGO=1
    export ASEC_MOUNTPOINT=/mnt/asec
    export HOSTNAME=oriole
    export TMPDIR=/data/local/tmp
    export ANDROID_ROOT=/system
    export ANDROID_I18N_ROOT=/apex/com.android.i18n

    export USER=root
    export PATH=/data/local/tmp/bin:/dev/.magisk:/product/bin:/apex/com.android.runtime/bin:/apex/com.android.art/bin:/system_ext/bin:/system/bin:/system/xbin:/odm/bin:/vendor/bin:/vendor/xbin
    export HOME=$BASE_DIR

    # Sometimes unstable behaviors like EACCESS on accessing file happen.
    # It may be caused by cache of old selinux policy.
    # Wait for flush of the cache.
    # TODO: Fix kernel module to flush cache manually.
    for i in `seq 1 100`; do
        rm $log
        result1=$?
        touch $log
        result2=$?
        if [ $result1 = 0 -a $result2 = 0 ]; then
            echo Successfully access log. Try=$i > $log
            break
        fi
        sleep 1
    done

    echo Start startup-root. BASE_DIR=$BASE_DIR >> $log

    #$BASE_DIR/magiskpolicy --save $BASE_DIR/policy-dump
    ln -s $BASE_DIR/magisk/magiskinit $BASE_DIR/magisk/magiskpolicy 2>> $log
    chmod 755 $BASE_DIR/magisk/magiskinit $BASE_DIR/magisk/magisk $BASE_DIR/magisk/busybox
    $BASE_DIR/magisk/magiskpolicy --magisk --live 2>> $log

    echo u:r:magisk:s0 > /proc/self/attr/current

    echo `date`: `id` >> $log

    # Send completion signal to restore files
    $BASE_DIR/magisk/busybox killall -s SIGUSR1 dirtypipe-android

    # INSECURE
    # $BASE_DIR/magisk/busybox telnetd -l /bin/sh -p 10848 &

    # Experimental Magisk root access.

    # Avoid error: 'CANNOT LINK EXECUTABLE "/system/bin/app_process64": library "libnativeloader.so" not found: needed by main executable'
    # startup-root is launched in bootstrap mount namespace. It prevent app_process from launch. Pull default ns from init to avoid it.
    # I don't know why we are in bootstrap mount ns even though we forked from init.
    $BASE_DIR/magisk/busybox nsenter -t 1 -m $0 magisk > $BASE_DIR/mylog2 2>&1 < /dev/null

else
    #set -e

    id

    $BASE_DIR/env-patcher || true
    
    $BASE_DIR/magisk/magisk resetprop "ro.product.name" "RMX3301" && echo "Successfully changed ro.product.name"

fi
